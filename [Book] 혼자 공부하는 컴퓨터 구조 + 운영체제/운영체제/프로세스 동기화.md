### 프로세스 동기화

운영체제의 프로세스 관리 서비스 중 가장 중요한 두 가지를 꼽자면 스케줄링과 동기화라고 할 수 있다.

동시다발적으로 실행되는 프로세스들은 공동의 목적을 올바르게 수행하기 위해 서로 협력하며 영향을 주고 받기도 한다.

협력하여 실행되는 프로세스들은 실행 순서와 자원의 일관성을 보장해야 하기에 반드시 동기화되어야 한다.

프로세스 동기화란 프로세스들 사이의 수행 시키를 맞추는 것을 의미한다. 이는 두 가지를 의미한다.

1. 실행 순서 제어: 프로세스를 올바른 순서대로 실행하기
2. 상호 배제: 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하기

(프로세스뿐만 아니라 스레드도 동기화 대상이다. 실행의 흐름을 갖는 모든 것은 동기화의 대상이다.)

#### 실행 순서 제어를 위한 동기화

Writer라는 프로세스와 Reader라는 프로세스가 동시에 실행 중이라고 가정해보자. 이 두 프로세스는 무작정 아무 순서대로 실행되어서는 안 된다. Reader 프로세스는 Writer 프로세스 실행이 끝나야 비로소 실행할 수 있기 때문이다.

#### 상호 배제를 위한 동기화

공유가 불가능한 자원의 동시 사용을 피하기 위해 사용하는 알고리즘이다. 만약 계좌에 2만원과 5만원을 각각 더하는 프로세스들이 있다면 동시에 실행되는 경우 각자 과정을 덮어씌워 최종적으로 5만원만 더해질 수도 있다.

##### 생산자와 소비자 문제

생산자와 소비자는 동시에 실행되는 스레드가 될 수도 있다.
둘 다 '총합'이라는 데이터를 공유하고 있다.
이들이 동기화되지 않은 채 동시에 실행되면 오류가 발생할 수 있다.
동시에 접근해서는 안 되는 자원에 동시 접근했기 때문이다.

공동의 자원을 *공유 자원*이라고 한다. 공유 자원은 전역 변수가 될 수도 있고, 파일, 입출력장치, 보조기억장치가 될 수도 있다.

동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역을 *임계 구역*이라고 한다. 두 개 이상의 프로세스가 임계 구역에 진입하고자 하면 둘 중 하나는 대기해야 한다.
이를 지키지 못 하고 동시 다발적으로 임계 구역의 코드를 실행해서 문제가 발생하는 경우를 레이스 컨디션이라고 한다.

컴퓨터는 고급 언어가 아닌 저급 언어를 실행하기 때문에 여러 줄의 저급 언어로 변환된 고급 언어 한 줄을 실행하는 과정에서 문맥 교환이 일어날 수 있다.

- 상호 배제(mutual exclusion): 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없다.

- 진행(progress): 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 한다.

- 유한 대기(bounde waiting): 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 한다.

#### 동기화 기법

동기화를 위한 대표적인 도구로 뮤텍스 락, 세마포, 모니터가 있다.

임계 구역에 진입하는 프로세스는 지금 임계 구역에 있음을 알리기 위해 뮤텍스 락을 이용해 임계 구역에 자물쇠를 걸어둘 수 있다.
그렇게 되면 다른 프로세스가 이 구역에 진입할 때 접근을 하거나 안 하는 것을 판단할 수 있다.

##### 뮤텍스 락

자물쇠 역할: 프로세스들이 공유하는 전역 변수 lock
임계 구역을 잠그는 역할: acquire 함수
임계 구역의 잠금을 해제하는 역할: release 함수

acquire 함수는 프로세스가 임계 구역에 진입하기 전에 호출하는 함수다. 임계 구역이 잠겨 있다면 임계 구역이 열릴 때까지 반복적으로 확인하고, 열려 있다면 임계 구역을 잠근다. (이런 대기 방식을 바쁜 대기라고 한다.)

release 함수는 임계 구역에서의 작업이 끝나고 호출하는 함수다. 잠긴 임계 구역을 열어주는 함수다.

##### 세마포

세마포는 뮤텍스 락과 비슷하지만, 조금 더 일반화된 방식의 동기화 도구다. 공유 자원이 여러 개 있는 상황에서도 적용이 가능한 동기화 도구다.

(세마포에는 이진 세마포와 카운팅 세마포가 있다.)

세마포는 멈춤 신호와 가도 좋다는 신호로서 임계 구역을 관리한다.

세마포는 뮤텍스 락과 비슷하게 하나의 변수와 두 개의 함수로 단순하게 구현할 수 있다.

임계 구역에 진입할 수 있는 프로세스의 개수를 나타내는 전역 변수 S
임계 구역에 들어가도 좋은지, 기다려야 할지를 알려주는 wait 함수
임계 구역 앞에서 기다리는 프로세스에 가도 좋다고 신호를 주는 signal 함수.

(세마포 변수의 이름과 함수 이름은 전공서마다 다를 수 있다.)

세마포도 공유 자원이 없는 경우 무작정 무한히 반복하며 S를 확인한다.
따라서 실제로 세마포는 더 좋은 방법을 사용한다.

wait 함수는 만일 사용할 수 있는 자원이 없을 경우 해당 프로세스 상태를 대기 상태로 만들고 대기 큐에 집어넣는다. 그리고 다른 프로세스가 임계 구역에서의 작업이 끝나고 signal 함수를 호출하면 signal 함수는 대기 중인 프로세스를 대기 큐에서 제거하고, 프로세스 상태를 준비 상태로 변경한 뒤 준비 큐로 옮겨준다.

##### 모니터

세마포에서 매번 임계 구역에 앞뒤로 일일이 wait와 signal 함수를 명시하는 것은 번거로운 일이다. 따라서 최근에 모니터라는 동기화 도구가 등장했다. 모니터는 공유 자원과 공유 자원에 접근하기 위한 인터페이스를 묶어 관리한다.
그리고 프로세스는 반드시 인터페이스를 통해서만 공유 자원에 접근하도록 한다. 이를 위해 모니터를 통해 공유 자원에 접근하고자 하는 프로세스를 큐에 삽입하고, 큐에 삽입된 순서대로 하나씩 공유 자원을 이용하도록 한다. 즉, 모니터는 공유 자원을 다루는 인터페이스에 접근하기 위한 큐를 만들고, 모니터 안에 항상 하나의 프로세스만 들어오도록 하여 상호 배제를 위한 동기화를 제공한다.

이 밖에도 모니터는 세마포와 마찬가지로 실행 순서 제어를 위한 동기화도 제공한다. 특정 조건을 바탕으로 프로세스를 실행하고 일시 중단하기 위해 모니터는 조건 변수를 사용한다. 조건 변수는 프로세스나 스레드의 실행 순서를 제어하기 위해 사용하는 특별한 변수다.

조건 변수로 wait와 signal 연산을 수행할 수 있다.
