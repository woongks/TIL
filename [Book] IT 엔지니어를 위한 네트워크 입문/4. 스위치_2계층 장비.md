### 스위치 장비 동작

스위치는 MAC 주소를 기반으로 동작한다. 스위치를 아무 설정 없이 네트워크에 연결해도 MAC 주소를 기반으로 패킷을 전달하는 기본 동작을 수행할 수 있다.

스위치는 MAC 주소를 인식하고 패킷을 전달하는 기본 동작 외에도 한 대의 장비에서 논리적으로 네트워크를 분리할 수 있는 VLAN 기능과 네트워크의 루프를 방지하는 스패닝 트리 프로토콜과 같은 기능을 기본적으로 가지고 있다.

각 계층에서 헤더와 데이터(페이로드)를 합친 부분을 PDU(Protocol Data Unit)이라고 부른다. 1계층 PDU는 비트, 2계층 PDU는 프레임, 3계층 PDU는 패킷, 4계층은 세그먼트라고 부르고 애플리케이션에 해당하는 3개 계층(세션, 표현, 응용)은 데이터라고 부른다.

스위치가 없던 오래된 이더넷 네트워크에서는 패킷(프레임)을 전송할 때 서로 경합해 그로 인한 네트워크 성능 저하가 컸다. 이런 경쟁을 없애고 패킷을 동시에 여러 장비가 서로 간섭 없이 통신하도록 도와주는 장비가 스위치다. 스위치를 사용하면 여러 단말이 한꺼번에 통신할 수 있어 통신하기 위해 기다리거나 충돌 때문에 대기하는 문제가 해결되고 네트워크 전체의 통신 효율성이 향상된다.

스위치의 핵심 역할은 누가 어느 위치에 있는지 파악하고 실제 통신이 시작되면 자신이 알고 있는 위치로 패킷을 정확히 전송하는 것이다. 이런 동작은 스위치가 2계층 주소를 이해하고 단말의 주소인 MAC 주소와 단말이 위치하는 인터페이스 정보를 매핑한 MAC 주소 테이블을 갖고 있어서 가능하다.

스위치는 전송하려는 패킷의 헤더 안에 있는 2계층 목적지 주소를 확인하고 MAX 주소 테이블에서 해당 주소가 어느 포트에 있는지 확인해 해당 패킷을 그 포트로만 전송한다. 만약 테이블에 없는 도착지 주소를 가진 패킷이 스위치로 들어오면 스위치는 전체 포트로 패킷을 전송한다. 패킷의 도착지 주소가 테이블에 있으면 해당 주소가 매핑된 포트로만 패킷을 전송하고 다른 포트로는 전송하지 않는다. 스위치의 동작 방식은 3 가지로 정리할 수 있다.

1. 플러딩
2. 어드레스 러닝
3. 포워딩/필터링

#### 플러딩

스위치를 부팅하면 네트워크 관련 정보가 아무 것도 없다. 이때 스위치는 통신을 중재하는 역할을 하지 못하고 허브처럼 동작한다. 허브는 패킷이 들어온 포트를 제외하고 모든 포트로 패킷을 전달한다. 스위치가 허브와 같이 모든 포트로 패킷을 흘리는 동작 방식을 플러딩이라고 한다.

이더넷-TCP/IP 네트워크에서는 ARP 브로드캐스트를 미리 주고받은 후 데이터가 전달되므로 실제로 데이터를 보내고 받을 때는 스위치가 패킷을 플러딩하지 않는다. 스위치를 사용하면 필요한 곳에만 패킷을 포워딩하므로 보안에 도움이 된다. 이 원리를 이용해 스위치에 엉뚱한 MAC 주소를 습득시키거나 MAC 테이블을 꽉 차게 해 스위치의 플러딩 동작을 유도할 수 있다. 이 외에도 ARP 포이즈닝 기법을 이용해 모니터링해야 할 IP의 MAC 주소가 공격자 자신인 것처럼 속여 원하는 통신을 받는 방법을 사용하기도 한다.

#### 어드레스 러닝

스위치가 동작을 정상적으로 수행하려면 MAC 주소 테이블을 만들고 유지해야 한다. MAC 주소 테이블은 어느 포트에 어떤 MAC 주소가 연결되었는지에 대한 정보가 저장되어 있는 임시 테이블이다. 이런 테이블을 만들고 유지하는 과정을 어드레스 러닝이라고 한다.

어드레스 러닝은 패킷의 출발지 MAC 주소 정보를 이용한다. 패킷이 특정 포트에 들어오면 스위치에는 해당 패킷의 출발지 MAC 주소와 포트 번호를 MAC 주소 테이블에 기록한다. 1번 포트에서 들어온 패킷의 출발지 MAC주소가 AAAA라면 1번 포트에 AAAA MAC 주소를 가진 장비가 연결되어 있다고 추론할 수 있어 이런 방법으로 주소 정보를 습득한다. 즉, 브로드캐스트나 멀티캐스트에 대한 MAC 주소를 학습할 수 없다.

#### 포워딩/필터링

스위치의 동작은 매우 간단하다. 패킷이 스위치에 들어온 경우, 도착지 MAC 주소를 확인하고 자신이 가진 MAC 테이블과 비교해 맞는 정보가 있으면 매치되는 해당 포트로 패킷을 포워딩한다. 이때 다른 포트로는 해당 패킷을 보내지 않으므로 이 동작을 필터링이라고 한다. 스위치는 이런 포워딩과 필터링을 통해 목적지로만 패킷이 전달되도록 동작한다.

스위치는 일반적인 유니캐스트에 대해서만 포워딩과 필터링 작업을 수행한다. BUM 트래픽이라고 부르는 브로드캐스트와 언노운 유니캐스트, 멀티캐스트에는 조금 다르게 동작한다. 이런 트래픽은 모두 플러딩한다.

이더넷-TCP/IP 네트워크에서는 스위치가 유니캐스트를 플러딩하는 경우는 거의 없다. ARP 브로드캐스트를 먼저 수행하기 때문이다. 이 ARP를 이용한 MAC 주소 습득 과정에서 이미 스위치는 통신하는 출발지와 목적지의 MAC 주소를 습득할 수 있고 실제 유니캐스트 통신이 시작되면 이미 만들어진 MAC 주소 테이블로 패킷은 포워딩, 필터링한다. ARP와 MAC 테이블은 일정 시간 동안 지워지지 않는데 이 시간을 에이징 타임이라고 한다. 일반적으로 MAC 테이블의 에이징 타임이 단말의 ARP 타임보다 길어 이더넷 네트워크를 플러딩없이 효율적으로 운영할 수 있다.

### VLAN

네트워크에는 다양한 가상화 기술이 쓰이고 있는데 스위치에서는 오래 전부터 VLAN이라는 가상화 기술을 사용해왔다. 하나의 물리 스위치에서 여러 개의 네트워크를 나누어 사용할 수 있다. 즉, 물리적 배치와 상관없이 LAN을 논리적으로 분할, 구성하는 기술이다. 과도한 브로드캐스트로 인한 단말들의 성능 저하, 보안 향상을 위한 차단 용도, 서비스 성격에 따른 정책 적용과 같은 이유로 네트워크가 분리될 필요가 있다.

VLAN을 나누면 하나의 장비를 서로 다른 네트워크를 갖도록 논리적으로 분할한 것이므로 유니캐스트뿐만 아니라 브로드캐스트도 VLAN 간에 통신할 수 없다. VLAN 간의 통신이 필요하다면 서로 다른 네트워크 간의 통신이므로 3계층 장비가 필요하다.

VLAN을 사용하면 물리적 구성과 상관없이 네트워크를 분리할 수 있고 다른 층에 있는 단말이 하나의 VLAN을 사용해 동일한 네트워크로 묶을 수 있다. 이렇게 분리된 단말은 3계층 장비를 통해 통신하게 된다.

이런 논리적 스위치 간에 통신을 하려면 스위치 안의 VLAN 별로 연결을 하면 된다.
만약 스위치에 VLAN이 3개가 구성된 경우 3개의 포트를 스위치 간 통신을 위해 써야 한다. 이는 비효율적이기 때문에 해결하기 위해 VLAN 태그 기능이 등장했다. 태그 기능은 하나의 포트에 여러 개의 VLAN을 함께 전송할 수 있게 해준다. 이 포트를 태그 포트 또는 트렁크 포트라고 한다. 여러 개의 VLAN을 동시에 전송해야 하는 태그 포트는 통신할 때 이더넷 프레임 중간에 VLAN ID 필드를 끼워 넣어 이 정보를 이용한다.

태그 포트 기능이 생기면서 다른 VLAN끼리 통신을 못하도록 MAC 테이블에 VLAN을 지정하는 필드가 추가된다. 즉, VLAN 별로 MAC 주소 테이블이 존재하는 것처럼 동작한다.

일반적인 포트를 언태그, 또는 액세스 포트라고 하고 VLAN 정보를 넘겨 여러 VLAN이 한꺼번에 통신하도록 해주는 포트를 태그 포트 또는 트렁크 포트라고 부른다.

### STP

IT 환경에서는 SPoF (Single Point of Failure: 단일 장애점)로 인한 장애를 피하기 위해 다양한 노력을 한다. SPoF란 하나의 시스템이나 구성 요소에서 고장이 발생했을 때 전체 시스템의 작동이 멈추는 요소를 말한다. 네트워크에서도 하나의 장비 고장으로 전체 네트워크가 마비되는 것을 막기 위해 이중화, 다중화된 네트워크를 디자인하고 구성한다. 네트워크를 스위치 하나로 구성했을 때, 그 스위치에 장애가 발생하면 전체 네트워크에 장애가 발생한다.



STP란 스패닝 트리 프로토콜의 약자이며 루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 메커니즘이다. 전체적인 스위치 연결 상황을 파악하려면 스위치 간에 정보를 전달해야 하는데, 이때 BPDU(Bridge Protocol Data Unit)라는 프로토콜을 사용한다. 이를 통해 전체 네트워크 트리를 만들어 루프 구간을 확인한다.

BPDU에는 스위치가 갖고 있는 ID와 같은 고유값이 들어가고 이런 정보들이 스위치 간에 서로 교환되면서 루프 파악이 가능해진다. 이렇게 확인된 루프 지점을 데이터 트래픽이 통과하지 못하도록 차단해 루프를 예방한다.

STP가 동작 중인 스위치에서는 루프를 막기 위해 스위치 포트에 신규 스위치가 연결되면 바로 트래피이 흐르지 않도록 차단한다. 그리고 해당 포트로 트래픽이 흘러도 되는지 확인하기 위해 BPDU를 기다려 학습하고 구조를 파악한 후 트래픽을 흘리거나 루프 구조인 경우, 차단 상태를 유지한다. 차단 상태에서 트래픽이 흐를 때까지 스위치 포트의 상태는 4가지로 구분할 수 있다.

Blocking  
> 패킷 데이터를 차단한 상태로 상대방이 보내는 BPDU를 기다린다.  
총 20초인 Max Age 기간 동안 상대방 스위치에서 BPDU를 받지 못했거나 후순위 BPDU를 받았을 때 포트는 리스닝 상태로 변경된다.  
BPDU 기본 교환 주기는 2초이고 10번의 BPDU를 기다린다.

Listening
> 리스닝 상태는 해당 포트가 전송 상태로 변경되는 것을 결정하고 준비하는 단계다.  
이 상태부터는 자신의 BPDU 정보를 상대방에게 전송하기 시작한다.  
총 15초 동안 대기한다.  

Learning
> 러닝 상태는 이미 포트를 포워딩하기로 결정하고 실제로 패킷 포워딩이 일어날 때 스위치가 곧바로 동작하도록 MAC 주소를 러닝하는 단계다.  
총 15초 동안 대기한다.  

Forwarding
> 패킷을 포워딩하는 단계다. 정상적인 통신이 가능하다.
스위치에 신규로 장비를 붙이면 통신하는 데 50여 초가 소요된다. 스위치는 루프를 예방하기 위해 방어적으로 동작하는데, 새로 연결된 단말이 스위치일 가능성이 있기 때문에 BPDU를 일정 시간 기다려 스위치 여부를 파악한다. 이로 인해 스위치 외에 일반 단말을 연결하더라도 동일한 시간이 필요하다.

링크 전환도 STP의 동작 순서대로 진행된다. 특정 링크가 다운되어 블로킹 포트가 포워딩되기 위해 초기와 마찬가지로 20초 동안 Max Age를 거쳐 총 50초 후 포워딩 상태로 변경된다. 다운된 링크가 자신의 인터페이스인 경우, 토폴로지가 변했음을 직접 감지할 수 있어 Max Age를 거치지 않고 리스닝부터 STP 상태 변화가 즉시 이루어지므로 30초만에 전환된다.

STP가 활성화된 경우, 스위치 포트는 곧바로 포워딩 상태가 되지 않는다. 이로 인해 다양한 장애가 발생하거나 스위치 이상으로 생각되는 경우가 많다. 특히 부팅 시간이 매우 빠른 OS가 DHCP 네트워크에 접속할 때 부팅 단계에서 IP를 요청하지만 스위치 포트가 포워딩 상태가 되지 않아 IP를 정상적으로 할당받지 못하는 경우가 많다.

#### STP 동작 방식

STP는 루프를 없애기 위해 나무가 뿌리에서 가지로 뻗어나가는 것처럼 토폴로지를 구성한다. 네트워크상에서 뿌리가 되는 가장 높은 스위치를 선출하고 그 스위치를 통해 모든 BPDU가 교환되도록 하는데 그 스위치를 루트 스위치라고 한다.

모든 스위치는 처음에 자신을 루트 스위치로 인식해 동작한다. BPDU를 통해 2초마다 자신이 루트 스위치임을 광고하는데 새로운 스위치가 들어오면 서로 교환된 BPDU에 들어 있는 브릿지 ID 값을 비교한다. 브릿지 ID 값이 더 적은 스위치를 루트 스위치로 선정하고 루트 스위치로 선정된 스위치가 BPDU를 다른 스위치 쪽으로 보낸다.

동작 방식
1. 하나의 루트 스위치를 선정
- 전체 네트워크에 하나의 루트 스위치 선정
- 자신을 전체 네트워크의 대표 스위치라고 적은 BPDU를 옆 스위치로 전달
2. 루트가 아닌 스위치 중 하나의 루트 포트를 선정한다.
- 루트 브릿지로 가는 경로가 가장 짧은 포트를 루트 포트라고 한다.
- 루트 브릿지에서 보낸 BPDU를 받는 포트다.
3. 하나의 세그먼트에 하나의 지정 포트를 선정한다.
- 스위치와 스위치가 연결되는 포트는 하나의 지정 포트를 선정
- 이미 루트 포트로 선정된 경우 반대쪽이 지정 포트로 선정되어 양쪽 모두 포워딩 상태가 된다.
- 스위치 간의 연결에서 아무도 루트 포트가 아닐 경우 한쪽은 지정, 한쪽은 대체 포트가 되어 차단 상태가 된다.
- BPDU가 전달되는 포트다.

포트 패스트
> 특정 포트를 포트 패스트로 설정하면 BPDU 대기, 습득 과정 없이 곧바로 포워딩 상태로 포트를 사용할 수 있다. 하지만 루프가 생길 수 있어 별도로 해당 포트에 BPDU가 들어오자마자 포트를 차단하는 BPDU 가드 같은 기술이 함께 사용되어야 한다.

향상된 STP(RSTP, MST)
> STP는 블로킹 포트가 포워딩 상태로 변경되기까지 30~50초가 소요된다. 통신에 가장 많이 쓰이는 TCP 기반 애플리케이션이 네트워크가 끊겼을 때 30초를 기다리지 못하다보니 STP 기반 네트워크에 장애가 생기면 통신이 끊길 수 있다. 또한, 스위치에 여러 개의 VLAN이 있으면 각 VLAN 별로 스패팅 트리 프로토콜을 계산하면서 부하가 발생하기도 한다.

RSTP(Rapid Spanning Tree Protocol)
> RSTP는 2~3초로 전환(절체) 시간이 짧아 일반적인 TCP 기반 애플리케이션이 세션을 유지할 수 있게 된다.
기본적인 구성과 동작 방식은 STP와 같지만 BPDU 메시지 형식이 다양해져 여러 가지 상태 메시지를 교환할 수 있다. STP는 일반 토폴로지 변경과 관련된 두 가지 메시지만 있지만 RSTP는 8개 비트를 모두 활용해 다양한 정보를 주위 스위치와 주고받을 수 있다.

기존 STP에서는 토폴로지가 변경되면 말단 스위치에서 루트 브릿지까지 변경 보고를 보내고 루트 브릿지가 그에 대한 연산을 다시 완료하고 이후 변경된 토폴로지 정보를 말단 스위치까지 보내는 과정을 거쳤다. 추가로 해당 정보가 네트워크에 있는 모든 스위치까지 전파되는 예비시간까지 고려해야 하므로 정보를 확정하는 데 시간이 오래 걸렸다. 하지만 RSTP에서는 토폴로지 변경이 일어난 스위치 자신이 모든 네트워크에 토폴로지 변경을 직접 전파할 수 있다. RSTP는 다양한 BPDU 메시지, 대체 포트 개념, 토폴로지 변경 전달 방식의 변화로 일반 STP보다 빠른 시간 내에 토폴로지 변경을 감지, 복구할 수 있다. 실제로 RSTP는 불과 2~3초 안에 장애 복구가 가능하므로 장애가 발생해 경로가 절체되더라도 애플리케이션 세션이 끊기지 않아 보다 안정적으로 네트워크를 운영하는 데 도움이 된다.

#### MST
일반 스패닝 트리 프로토콜은 CST(Common Spanning Tree)라고 부른다. VLAN 개수와 상관없이 스패닝 트리 한 개만 동작하게 된다. 이 경우, VLAN이 많더라도 스패닝 트리는 한 개만 동작하면 되므로 스위치의 관리 부하가 적다. 하지만 CST는 루프가 생기는 토폴로지에서 한개의 포트와 회선만 활성화되므로 자원을 효율적으로 활용할 수 없다. 또한, VLAN마다 최적의 경로가 다를 수 있는데 포트 하나만 사용할 수 있다보니 멀리 돌아 통신해야 할 경우도 생긴다.

이 문제를 해결하기 위해 PVST(Per Vlan Spanning Tree)가 개발되었고 VLAN마다 다른 스패닝 트리 프로세스가 동작하므로 VLAN마다 별도의 경로와 트리를 만들 수 있게 되었다. 그 덕분에 최적의 경로를 디자인하고 VLAN마다 별도의 블록 포트를 지정해 네트워크 로드를 셰어링하도록 구성할 수 있게 되었다.

하지만 스패닝 트리 프로토콜 자체가 스위치에 많은 부담을 주는 프로토콜인데, PVST는 모든 VLAN마다 별도의 스패닝 트리를 유지해야 하므로 더 많은 부담이 되었다. 이런 CST와 PVST의 단점을 보완하기 위해 MST(Multiple Spanning Tree)가 개발되었다.

MST는 여러 개의 VLAN을 그룹으로 묶고 그 그룹마다 별도의 스패닝 트리를 동작시킨다. 이 경우, PVST보다 훨씬 적은 스패닝 트리 프로토콜 프로세스가 돌게 되고 PVST의 장점인 로드 셰어링 기능도 함께 사용할 수 있다.

일반적으로 대체 경로의 개수나 용도에 따라 MST의 스패닝 트리 프로토콜 프로세스 개수를 정의한다. MST에서는 리전 개념이 도입되어 여러 개의 VLAN을 하나의 리전으로 묶을 수 있다.

스위치 구조
> 스위치는 스위치 관리용 컨트롤 플레인과 패킷을 포워딩하는 데이터 플레인으로 크게 나뉜다. STP, SSH, 텔넷, 웹 같은 서비스는 컨트롤 플레인에서 수행된다. 스위치는 일반적으로 MAC 주소만 이해할 수 있지만 일정 규모 이상의 네트워크에서 운영되는 스위치는 관리 목적으로 대부분 IP 주소가 할당된다.