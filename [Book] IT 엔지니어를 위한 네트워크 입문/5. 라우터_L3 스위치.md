### 라우터/L3 스위치: 3계층 장비

라우터는 3계층에서 동작하는 여러 네트워크 장비의 대표격으로 그 이름처럼 경로를 지정해주는 장비다. 라우터에 들어오는 패킷의 목적지 IP 주소를 확인하고 자신이 가진 경로 정보를 이용해 패킷을 최적의 경로로 포워딩한다.

라우터는 원격지 네트워크와 연결할 때 필수 네트워크 장비이며 네트워크를 구성하는 핵심 장비다.

#### 라우터의 동작 방식과 역할

라우터는 다양한 경로 정보를 수집해 최적의 경로를 라우팅 테이블에 저장한 후 패킷이 라우터로 들어오면 도착지 IP 주소와 라우팅 테이블을 비교해 최선의 경로로 패킷을 내보낸다. 라우터는 들어온 패킷의 목적지 주소가 라우팅 테이블에 없으면 패킷을 버린다. 라우터는 패킷 포워딩 과정에서 기존 2계층 헤더 정보를 제거한 후 새로운 2계층 헤더를 만들어낸다. 위에서 차례로 설명한 라우터의 동작 방식을 경로 지정, 브로드캐스트 컨트롤, 프로토콜 변환이라고 한다.

##### 경로 지정

라우터의 가장 중요한 역할은 경로 지정이다. 경로 정보를 모아 라우팅 테이블을 만들고 패킷이 라우터로 들어오면 패킷의 도착지 IP 주소를 확인해 경로를 지정하고 패킷을 포워딩한다. IP 주소는 네트워크 주소와 호스트 주소로 나뉜 계층 구조를 기반으로 설계되어 로컬 네트워크와 원격지 네트워크를 구분할 수 있고 네트워크 주소를 기반으로 경로를 찾아갈 수 있다. 라우터는 이 IP 주소를 확인해 원격지에 있는 적절한 경로로 패킷을 포워딩한다.

라우터는 경로를 지정해 패킷을 포워딩하는 역할을 두 가지로 구분해 수행한다. 경로 정보를 얻는 역할과 얻은 경로 정보를 확인하고 패킷을 포워딩하는 역할이다. 라우터는 자신이 얻은 경로 정보에 포함되는 패킷만 포워딩하므로 정확한 목적지 경로를 얻는 것이 매우 중요하다. 다양한 방법으로 경로 정보를 얻을 수 있는데 IP 주소를 입력하면서 자연스럽게 인접 네트워크 정보를 얻는 방법과 관리자가 직접 경로 정보를 입력하는 방법, 라우터끼리 서로 경로 정보를 자동으로 교환하는 방법이 있다.

##### 브로드캐스트 컨트롤(Broadcast Control)

스위치는 패킷의 도착지 주소를 모르면 어딘가에 존재할지 모를 장비와의 통신을 위해 플러딩해 패킷을 모든 포트에 전송한다. LAN 내부에서 플러딩이 발생한다.

만약 라우터에서 플러딩이된다면 인터넷에 쓸모 없는 패킷이 가득 찰 수도 있다. 라우터는 바로 연결되어 있는 네트워크 정보를 제외하고 경로 습득 설정을 하지 않으면 패킷을 포워딩할 수 없다. 라우터의 기본 동작은 멀티캐스트 정보를 습득하지 않고 브로드캐스트 패킷을 전달하지 않는다. 이 기능을 브로드캐스트 컨트롤/멀티캐스트 컨트롤이라고 한다. 네트워크에 브로드캐스트가 많이 발생하는 경우, 라우터로 네트워크를 분리하면 브로드캐스트 네트워크를 분할해 네트워크 성능을 높일 수 있다.

##### 프로토콜 변환

라우터의 또 다른 역할은 서로 다른 프로토콜로 구성된 네트워크를 연결하는 것이다.
라우터는 3계층에서 동작하는 장비이므로 3계층 주소 정보를 확인하고 그 정보를 기반으로 동작한다. 라우터에 패킷이 들어오면 2계층까지의 헤더 정보를 벗겨내고 3계층 주소를 확인한 후 2계층 헤더 정보를 새로 만들어 외부로 내보낸다. 그래서 라우터에 들어올 때의 패킷 2계층 헤더 정보와 라우터에서 나갈 때의 정보가 다르다. 이 기능을 이용하면 전혀 다른 기술 간 변환이 가능하다.

#### 경로 지정 - 라우팅/스위칭

라우터가 패킷을 처리할 때는 크게 두 가지 작업을 수행한다.

1. 경로 정보를 얻어 경로 정보를 정리하는 역할
2. 정리된 경로 정보를 기반으로 패킷을 포워딩하는 역할

라우터는 자신이 분명히 알고 있는 주소가 아닌 목적지를 가진 패킷이 들어오면 해당 패킷을 버리므로 패킷이 들어오기 전에 경로 정보를 충분히 수집하고 있어야 라우터가 정상적으로 동작한다. 인터넷에 존재하는 주소와 경로는 매우 많고 점점 늘고 있다. 클래스리스 네트워크로 전환된 후에는 같은 클래스에 있는 주소조차 서브네팅된 상태로 분산되어 존재하므로 경로 정보가 기존보다 훨씬 많아졌다.

라우터가 원하는 목적지 정보와 정확히 일치하지 않는 경우가 더 많다. 라우터는 서브넷 단위로 라우팅 정보를 습득하고 라우팅 정보를 최적하하기 위해 서머리 작업을 통해 여러 개의 서브넷 정보를 뭉쳐 전달한다. 그래서 라우터에 들어온 패킷의 목적지 주소와 라우터가 갖고 있는 라우팅 테이블 정보가 정확히 일치하지 않더라도 수많은 정보 중 목적지에 가장 근접한 정보를 찾아 패킷을 포워딩해야 한다.

##### 라우팅 동작과 라우팅 테이블

현대 인터넷에서는 단말부터 목적지까지의 경로를 모두 책임지는 것이 아니라 인접한 라우터까지만 경로를 지정하면 인접 라우터에서 최적의 경로를 다시 파악한 후 라우터로 패킷을 포워딩한다. 네트워크를 한 단계씩 뛰어넘는다는 의미로 이 기법을 홉-바이-홉 라우팅이라고 부르고 인접한 라우터를 넥스트 홉이라고 부른다. 라우터는 패킷이 목적지로 가는 전체 경로를 파악하지 않고 최적의 넥스트 홉을 선택해 보내준다.

넥스트 홉을 지정할 때는 일반적으로 세 가지 방법을 사용할 수 있다.

- 다음 라우터의 IP를 지정하는 방법(넥스트 홉 IP 주소)
- 라우터의 나가는 인터페이스를 지정하는 방법
- 라우터의 나가는 인터페이스와 다음 라우터의 IP를 동시에 지정하는 방법

라우터에서 넥스트 홉을 지정할 때는 일반적으로 상대방 라우터의 인터페이스 IP 주소를 지정하는 방법을 사용한다. 특수한 경우에만 라우터의 나가는 인터페이스를 지정하는 방법을 쓸 수 있는데 상대방 넥스트 홉 라우터의 IP를 모르더라도 MAC 주소 정보를 알아낼 수 있을 때만 사용한다.

라우터에서 패킷을 어디로 포워딩할지 경로를 선택할 때는 출발지를 고려하지 않는다. 출발지와 상관없이 목적지 주소와 라우팅 테이블을 비교해 어느 경로로 포워딩할지 결정한다. 그래서 라우팅 테이블을 만들 때는 목적지 정보만 수집하고 패킷이 들어오면 목적지 주소를 확인해 패킷을 넥스트 홉으로 포워딩한다.

라우팅 테이블에 저장하는 데이터에는 다음과 같은 정보가 포함된다.

- 목적지 주소
- 넥스트 홉 IP 주소, 나가는 로컬 인터페이스

라우터에서 패킷의 출발지 주소를 이용해 라우팅하도록 PBR(Policy-Based Routing) 기능을 사용할 수 있지만 목적지 주소만 수집하는 라우팅 테이블로는 이 기능을 활성화할 수 없고 라우터 정책과 관련된 별도 설정이 필요하다. 이 경우, 다른 라우터로의 전파가 어렵고 라우터에 일반적이지 않은 별도 동작이 필요하다.

#### 라우팅 설정 방법

루프가 없는 3계층: TTL(Time To Live)

> 3계층의 IP 헤더에는 TTL이라는 필드가 있어 패킷이 네트워크에 살아 있을 수 있는 시간(홉)을 제한한다. 하지만 실제 운영되던 사이트가 갑자기 없어지는 경우가 발생할 수 있고 대안 경로를 찾다가 순간적으로 마주보는 두 대의 라우터의 넥스트 홉이 각각 상대방으로 구성되어 패킷이 두 라우터 사이에서 계속 오가는 경우도 생길 수 있다. 이를 라우팅 루프라고 한다.

라우터가 경로 정보를 얻는 방법은 매우 다양하지만 다음 3가지 방법으로 크게 구분할 수 있다.

1. 다이렉트 커넥티드
2. 스태틱 라우팅
3. 다이나믹 라우팅

다이렉트 커넥티드

> IP 주소를 입력할 때 사용된 IP 주소와 서브넷 마스크로 해당 IP 주소가 속한 네트워크 주소 정보를 알 수 있다. 라우터나 PC에서는 이 정보로 해당 네트워크에 대한 라우팅 테이블을 자동으로 만든다. 이 경로 정보를 다이렉트 커넥티드라고 부른다. 다이렉트 커넥티드로 생성되는 경로 정보는 인터페이스에 IP를 설정하면 자동 생성되는 정보이므로 정보를 강제로 지울 수 없고 해당 네트워크 설정을 삭제하거나 해당 네트워크 인터페이스가 비활성화되어야만 자동으로 사라진다.

스태틱 라우팅

> 관리자가 목적지 네트워크와 넥스트 홉을 라우터에 직접 지정해 경로 정보를 입력하는 것을 스태틱 라우팅이라고 한다. 스태틱 라우팅은 관리자가 경로를 직접 지정하므로 라우팅 정보를 매우 직관적으로 설정, 관리할 수 있다. 스태틱 라우팅은 다이렉트 커넥티드처럼 연결된 인터페이스 정보가 삭제되거나 비활성화되면 연관된 스태틱 라우팅 정보가 자동 삭제된다. 다만 물리 인터페이스가 아닌 논리 인터페이스는 물리 인터페이스가 비활서오하되더라도 함께 비활성화되지 않는 경우도 있어 라우팅 테이블에서 사라지지 않을 수 있다.

다이나믹 라우팅

> 스태틱 라우팅은 관리자가 변화가 적은 네트워크에서 네트워크를 손쉽게 관리할 수 있는 좋은 방법이지만 큰 네트워크는 스태틱 라우팅만으로는 관리가 어렵다. 스태틱 라우팅은 라우터 너머의 다른 라우터의 상태 정보를 파악할 수 없어 라우터 사이의 회선이나 라우터에 장애가 발생하면 장애 상황을 파악하고 대체 경로로 패킷을 보낼 수 없기 때문이다. 또 네트워크 규모가 커지면 관리자가 직접 관리하는 것에 한계가 있다.

> 다이나믹 라우팅은 스태틱 라우팅의 이런 단점을 보완해준다. 라우터끼리 자신이 알고 있는 경로 정보나 링크 상태 정보를 교환해 전체 네트워크 정보를 학습한다. 주기적으로 또는 상태 정보가 변경될 때 라우터끼리 경로 정보가 교환되므로 라우터를 연결하는 회선이나 라우터 자체에 장애가 발생하면 이 상황을 인지해 대체 경로로 패킷을 포워딩할 수 있다. 관리자의 개입 없이 라우터끼리의 정보교환만으로 장애를 인지하고 트래픽을 우회할 수 있으므로 대부분의 네트워크에서 다이나믹 라우팅이 사용된다.
