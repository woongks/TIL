시스템이 처리하는 데이터와 시스템상에서의 데이터 흐름을 구체적으로 살펴볼 것.

### 3계층형 시스템의 구성도

웹 서버와 AP 서버, DB 서버로 나뉜다.
각 서버는 스위치를 경유해 연결되어 있다.
서버의 논리 구성은 OS에서 이루어진다.

#### 프로세스와 스레드

프로세스와 스레드가 활동하려면 메모리 공간이 필요하다. 커널에 의해 메모리에서 공간이 확보된다. 이 메모리 공간은 다양한 처리를 하면서 데이터를 주고받기 위해 확보된 개인 공간이다.
하나의 프로세스가 동작하고 있으면 내부에서는 메모리 공간을 점유하는 스레드 하나가 동작하고 있다. 각 스레드는 메모리 공간을 공유하고 있다. 스레드 시작 시에 신규 메모리 공간은 필요 없지만 다른 스레드에 이상이 발생하면 영향을 받는다.

프로세스와 스레드 중에 어떤 것을 이용할지는 애플리케이션 개발자가 정한다. 이때 각각의 특성을 이해하고 설계와 프로그래밍할 필요가 있다.
예를 들어, 프로세스는 독자 메모리 공간을 가지기 때문에 생성 시 CPU 부하가 스레드와 비교해 높아진다. 때문에 멀티 프로세스 애플리케이션에서는 프로세스 생성 부담을 낮추기 위해 미리 프로세스를 시작시켜 둔다.

프로세스와 스레드의 장단점
||프로세스|스레드|
|---|---|---|
|장점|개별 처리 독립성이 높다|생성 시 부하가 낮다|
|단점|생성 시 CPU 부하가 높다|메모리 공간을 공유하기 때문에 의도하지 않는 데이터 읽기/쓰기가 발생할 수 있다|

프로세스가 메모리 공간을 공유할 수 없는 것은 아니다.
예를 들어 오라클 DB에서는 여러 프로세스가 공유 메모리 공간을 상호 이용할 수 있게 되어 있다.

#### OS 커널

커널은 OS의 심장과 같다. 커널은 뒤에서 무슨 일이 벌어지는지 은폐하면서도 편리한 인터페이스를 제공하는 역할을 한다.

커널의 역할은 크게 6가지가 있다.

1. 시스템 콜 인터페이스: 프로세스나 스레드로부터 명령을 받음
2. 프로세스 관리: 프로세스 관리와 CPU 이용 우선순위 스케줄
3. 메모리 관리: 메모리를 블록 단위로 분할해서 프로세스에 할당
4. 네트워크 스택: 네트워크 관리
5. 파일 시스템 관리
6. 장치 드라이버: 디스크, NIC, HBA 등의 물리 장치와 작업

시스템 콜 인터페이스

> 프로세스/스레드에서 커널로 연결되는 인터페이스다. 애플리케이션이 OS를 통해서 어떤 처리를 하고 싶으면 시스템 콜이라고 하는 명령을 이용해서 커널에 명령을 내린다. 이때 명령이 인터페이스를 통해서 전달된다. (디스크 I/O와 네트워크 I/O 모두 시스템 콜이다)

프로세스 관리

> OS상에서는 수십, 수백, 수천 개의 프로세스를 가동할 수 있다. 이에 비해 물리 서버의 CPU 코어 수는 많아야 수십 개 정도밖에 안 된다. 언제 어떤 프로세스가 어느 정도의 CPU 코어를 이용할 수 있는지, 처리 우선순위를 어떻게 결정할 것인지 등을 관리하는 것이 이 기능의 역할이다.

메모리 관리

> 프로세스 관리는 CPU 코어를 고려했지만, 메모리 관리에서는 물리 메모리 공간의 최대치를 고려한다. 프로세스가 이용하는 독립 메모리 공간을 확보하거나 상호 간의 참조 영역을 지키기 위해 독립성을 관리하는 등의 메모리 관리 역할을 한다.

파일 시스템 관리

> 파일 시스템용 인터페이스를 제공한다. 0과 1의 숫자 집합에 파일이라는 단위로 데이터를 작성하거나 삭제할 수 있게 한다.

장치 드라이버

> 디스크나 NIC 등의 물리 장치용 인터페이스를 제공한다. 예를 들어, NIC나 디스크는 다수의 제조사가 독자 제품을 제공하고 있다. 각각에 대응하는 애플리케이션을 개발하는 것은 현실적이지 못하기 때문에 커널은 장치 드라이버를 이용해서 그 아래에 있는 물리 장치를 은폐한다. 각 장치 제조사가 OS에 대응하는 장치 드라이버를 제공해서 해당 OS의 표준 장치로서 커널을 경유해 이용할 수 있게 한다.

커널 설계 및 구현 방식에는 모노리식과 마이크로가 있다. 모노리식 커널은 OS의 주요 구성 요소를 모두 하나의 메모리 공간을 통해 제공한다. 마이크로 커널은 최소한의 기능만 커널이 제공하고 그 외 기능은 커널 밖에서 제공한다.

### 웹 데이터 흐름

#### 클라이언트 PC부터 웹 서버까지

클라이언트 PC에서 웹 브라우저를 실행해서 웹 서버에 요청을 보내고 AP 서버에 질의하기까지의 흐름을 아는 것은 중요하다.

전체 흐름은 다음과 같다.

1. 웹 브라우저가 요청을 발행한다.
2. 이름 해석을 한다.
3. 웹 서버가 요청을 접수한다.
4. 웹 서버가 정적 콘텐츠인지 동적 콘텐츠인지 판단한다.
5. 필요한 경로로 데이터에 액세스한다.

웹 서버에는 HTTP를 처리할 수 있는 'httpd 프로세스'가 가동되고 있다. 아파치에서는 기본적으로 부모 프로세스와 자식 프로세스로 나누어 처리를 분담하고 있다.

요청에 대한 대답 내용은 HTML 파일이라는 텍스트 데이터나 이미지, 동영상 등의 바이너리 데이터로 구성된다. 이 데이터들은 '정적 콘텐츠'와 '동적 콘텐츠'로 분류할 수 있다.
'정적 콘텐츠'란 실시간으로 변경할 필요가 없는 데이터를 가리킨다.
'동적 콘텐츠'란 높은 빈도로 변경되는 데이터를 가리킨다.
동적 콘텐츠는 서버 내부의 디스크에 저장하면 갱신 빈도가 높아 디스크 성능이 병목 현상의 원인이 될 수 있다. 또한, 파일이라는 형태로 저장하는 것 자체가 비효율적일 수 있다. 일반적으로 이런 동적 콘텐츠는 'AP 서버'가 HTML 파일을 동적으로 생성한다. 웹 서버는 동적 콘텐츠에 대한 요청을 AP 서버에 던지고 결과를 기다린다.

#### 웹 서버부터 AP 서버까지

'동적 콘텐츠'에 대한 요청을 처리하는 것이 AP 서버다.

1. 웹 서버로부터 요청이 도착한다.
2. 스레드가 요청을 받으면 자신이 계산할 수 있는지, 아니면 DB 접속이 필요한지를 판단한다.
3. DB 접속이 필요하면 연결 풀에 액세스한다.
4. DB 서버에 요청을 던진다.

웹 서버에서 온 요청은 NIC를 경유해서 커널에 의해 끼어들기 처리된다.
스레드가 요청을 접수한다.
동적 데이터를 가져오기 위해 연결 풀을 이용하여 DB에 접속한다.
DB에 보내는 접속 요청도 물론 시스템 콜을 이용한다.
네트워크 경유로 DB 서버에 대한 질의가 이루어진다.

대량의 데이터는 AP서버가 감당할 수 없고 DB서버에 저장한다.
데이터는 AP서버가 DB서버에 질의를 하고 그 결과를 HTML 등으로 정리해서 반환한다. AP서버가 DB서버에 접속하려면 '드라이버'가 필요하다. 장치 드라이버와 비슷하다. 드라이버 뒷단에 있는 것이 데이터베이스로 가는 인터페이스로, 해당 데이터베이스 자체를 은폐하는 역할을 한다.

DB서버 이외의 옵션?

> 데이터가 필요하면 DB 서버에 접속하는 것이 일반적이지만, 이것이 항상 효율적이라고 할 수는 없다. 규모가 작고 갱신 빈도가 낮은 정보는 캐시로 저장해 두었다가 변환하는 것이 좋다.

> 반대로 규모가 큰 정적 데이터 전송 시에는 DB서버 이외에 CDN이라 불리는 데이터 전송 전용 서버를 이용하는 경우도 있다.

#### AP서버부터 DB서버까지

DB서버가 요청을 접수하는데, 이때 언어는 SQL이다. SQL을 해석해서 데이터 액세스 방식을 결정하고, 디스크나 메모리에서 필요한 데이터만 수집해 오는 것이 데이터베이스의 주요 역할이다.

전체적인 흐름은 다음과 같다.

1. AP서버로부터 요청이 도착한다.
2. 프로세스가 요청을 접수하고 캐시가 존재하는지 확인한다.
3. 캐시에 없으면 디스크에 액세스 한다.
4. 디스크가 데이터를 반환한다.
5. 데이터를 캐시 형태로 저장한다.
6. 결과를 AP서버에 반환한다.
