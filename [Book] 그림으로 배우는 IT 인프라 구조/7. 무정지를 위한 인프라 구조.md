### 안정성 및 이중화

상용 시스템을 장애로부터 보호하기 위해서 빠트릴 수 없는 구조가 바로 안정성과 이중화다.

상용 시스템에서는 인프라가 '업무 기능의 토대'가 되지만 요구되는 몇 가지가 있다. 그 중 하나가 안정성이다. 고가용성이라고도 한다.

안정성, 고가용성이란, 시스템 서비스가 가능한 한 멈추지 않도록 하는 것을 말한다.

안정성, 고가용성의 목표

1. 고장, 장애에 의한 정지가 발생하지 않을 것
2. 고장, 장애가 발생해도 복구할 수 있을 것
3. 고장, 장애가 발생한 것을 검출할 수 있을 것
4. 고장, 장애가 발생해도 데이터가 보호될 것

컴포넌트 이중화: 1, 2
컴포넌트 감시: 3
데이터 백업: 4

상용 웹 시스템에서는 미들웨어 기능이나 구조로 이중화, 감시, 백업의 세 가지 수단을 구현해서 목표를 실현하고 있다. 또한, 이중화에는 안정성 확보 이외에도 다른 용도가 있다.

#### 이중화란?

이중화는 하나의 기능을 병렬로 여러 개 나열해서 하나에 장애가 발생해도 다른 것을 이용해서 서비스를 계속할 수 있는 것을 가리킨다. 하나의 기능이 병렬로 가동되기 때문에 이런 고가용성에 대한 의미뿐만 아니라 확장성이나 부하 분산 같은 성능에 대한 의미도 가진다.

이중화에 의한 안정성은 다양한 계층에서 실현할 수 있다.

1. H/W 컴포넌트 계층

- 전원이나 네트워크, 하드디스크 이중화다. 신뢰도가 비교적 낮은 부분과 데이터 보호를 목적으로 한다.

2. 시스템 계층

- 여러 서버에서 동일한 처리를 하는 서버 이중화다. 특정 서버의 처리가 중단돼도 다른 서버에서 처리를 지속해서 사용자에게는 영향을 주지 않는 것이 목적이다.

3. 물리적 위치 계층

- 시스템을 서로 다른 위치에서 운영하는 이중화다. 비용이 들지만 중요한 시스템을 위해 많은 기업들이 채택하는 방식이다. 비용과 신뢰도는 상호 상호의존관계다. 얼마나 비용을 아껴서 시스템의 신뢰도를 높이는가가 관건이다.

### 서버 내 이중화

일반적인 서버 내부 컴포넌트에서는 전원, 팬 등이 이중화돼 있다. 이들 중 하나가 망가져도 서버가 정상 가동하도록 설계돼 있다.

랙 뒤쪽의 양 끝에는 전원 탭이 붙어 있다. 양 끝에 있는 이유는 이중화 때문이다.
서버 설치 시에 이와 같이 설치해 두면 장애를 예방할 수 있다. 또한, 대규모 데이터 센터에서는 각 전원 탭이 별도 분전반이나 UPS에 접속돼 있어서 전원 장애에 대비하고 있다.

안정성을 고려할 때 중요한 것은 양쪽 전원 탭의 전력 합계를 최대로 사용하는 것이 아니라, 한쪽 전원 탭 전력만으로 서버가 가동될 수 있도록 소비 전력 합계를 낮추는 것이다. 한쪽 전원이 모두 공급되지 않아도 다른 한쪽의 전원만으로 시스템을 가동할 수 있기 때문이다. 서버의 소비 전력은 서버 사양서에 기록돼 있다.

#### 네트워크 인터페이스 이중화

PCI 슬롯에 꽂은 카드도 이중화가 가능하다. 네트워크 인터페이스나 파이버 채널 포트에는 이중화 기능이나 이중화를 실현하는 소프트웨어가 있다. 이 기능들을 전제로 카드 이중화 및 포트 이중화를 할 수 있다. 여러 개의 카드에 복수의 포트가 탑재되는 것이다. 이런 구성을 통해 카드 장애 및 포트 장애에 대응할 수 있다.
네트워크 인터페이스가 여러 개 있으면 이중화 소프트웨어나 기능을 이용해서 가용성과 성능을 향상시킬 수 있다.

네트워크 인터페이스 이중화는 하드웨어 또는 OS로 구현한다. 일반적으로는 액티브-스탠바이 구성이다. 액티브-스탠바이 구성은 마스터-워커 개념에 기반했다. 스탠바이 측은 보통 서비스를 제공하지 않는다. 액티브 측에 어떤 문제가 발생하면 스탠바이 장비로 교체돼서 스탠바이가 액티브로 변경된다. 이렇게 교체하는 것을 페일오버라고 한다.

네트워크 인터페이스 이중화의 대표적인 구현 방법 중 하나는 리눅스 OS의 본딩이다. 본딩에는 몇 가지 모드가 있는데, 그중 하나인 액티브-스탠바이 구성은 '액티브-백업'이라고 한다. 어떤 인터페이스가 마스터가 되는지는 설정에서 지정할 수 있다.

본딩이 이중화된 인터페이스를 감시하는 방식에는 두 가지가 있다. 'MII 감시'와 'ARP 감시'다. MII 감시는 MII(Media Independent Interface) 규격에 준거한 인터페이스의 링크 감시로, 현재 주류로 자리 잡고 있는 감시 방식이다. MII 감시에는 링크업(인터페이스가 가동되는 것)이 동작하고 있다면 정상이라고 판단한다. 한편, ARP 감시는 특정 IP 주소로 ARP 요청을 보내서 돌아오는 응답 유무에 따라 정상적인지를 확인하는 방법이다.

MII 감시가 선호되는 주된 이유는 다음과 같다:

- 불필요한 폴링 패킷이 전송되지 않는다.
- 폴링 위치로 지정한 IP 주소를 가진 장비에 대해서는 유지관리나 장애를 의식하지 않아도 된다.

물론 ARP 감시로만 인지할 수 있는 장애도 있다.

ARP 감시는 L2 계층에서 실시된다. ARP 요청을 정기적으로 실행해서 응답이 있으면 정상이라 판단한다. ARP 요청은 MAC 주소를 확인하는 브로드캐스트다. (브로드캐스트는 동일 네트워크 내의 모든 주소에 패킷을 전송하는 것)

ARP 감시의 단점은 폴링이 되는 ARP 요청이 동일 네트워크 내의 브로드캐스트이기 때문에 불필요한 트래픽이 증가한다는 것이다. 따라서 이 불필요한 트래픽을 고려해서 감시 빈도를 너무 높게 설정하지 않는 것이 중요하다. ARP 감시는 일반적으로 1~2초 간격 정도로 설정한다. 페일오버 구조는 감시 방법에 상관없이 동일하다.

인터페이스가 페일오버하면 스위치의 MAC 주소 테이블이 변경되고 통신이 재개된다. 이와 같이 네트워크 인터페이스 이중화인 본딩의 구현은 L3 네트워크보다 낮은 게층에서 구현되고 있다. 때문에 이중화 기능이 L7 애플리케이션 계층에서 구현돼 있으면 이상하다고 판단할 수 있는 감각이 필요하다.

ARP 감시에서는 임의의 IP 주소에 대해 ARP 요청을 보낼 수 있다. 주로 네트워크 게이트웨이로 요청을 보낸다. 반면 MII 감시는 인터페이스 링크 상태를 확인하기 때문에 접속돼 있는 L2스위치만 감시할 수 있다.

ARP 감시가 더 넓은 범위를 감시한다는 것을 알 수 있다. 이와 같이 기능의 장단점과 특성을 고려해서 시스템을 구현해야 한다.

### 저장소 이중화

#### HDD 이중화

저장소 이중화의 주요 대상은 HDD다. HDD는 가동 빈도가 높아서 고장 나기 쉽기 때문이다.

최근에는 잘 사용되지 않지만, 예전에는 서버 저장소를 파이버 채널로 연결하고 SAN(Storage Area Network)이라는 네트워크를 구축하는 방법이 유행했다. 하지만 최근에 접할 수 없는 이유는 높은 비용과 변경(증설 등)에 시간이 걸리기 때문이다.

요즘엔 TCP/IP 프로토콜상에 저장소 네트워크를 구축하는 방식이 늘고 있다. 하지만 TCP/IP 프로토콜상에 SCSI 프로토콜을 이용하는 등, 여러 기술을 조합했기 때문에 사용은 쉽지만 구조가 그만큼 복잡하다. 반면 SAN은 구조가 간단해서 이를 전제로 한 기술이 다시 개발되고 있다.

##### 저장소 내부 구조와 RAID

SAN에서는 IP 주소 대신에 WWN(World Wide Name)이라는 주소를 이용해서 데이터를 전송한다. LAN과는 다른 네트워크 토폴로지다. 또한, HDD 간을 연결하는 내부 버스에는 다양한 규격이 있지만 SAS(Serial Attached SCSI)가 유명하다.

컨트롤러에는 CPU나 캐시가 있으며, HDD의 I/O 제어를 하고 있다. HDD는 전용 박스(엔클로저나 셸프라고 한다)에 저장돼 있어서 증설하기가 쉽다.

각 장비에 IN과 OUT 포트가 있어서 계속 따라가다 보면 HDD까지 원형 연결이 만들어지는 것을 알 수 있다. 저장소는 이 원형 연결을 여러 개 준비해서 HDD 액세스 이중화를 도모하고 있다.

참고로, 서버가 저장소에 액세스할 때는 일반적인 액티브-스탠바이 또는 액티브-액티브 방식을 이용한다.

HDD 자체 이중화는 RAID를 사용한다.
RAID는 여러 HDD를 묶어서 그룹으로 만들고 이것을 논리적인 HDD로 인식하는 기술이다. 논리적 HDD를 LU(Local Unit)라고 한다. 서버가 인식하는 HDD는 이 LU다.

RAID의 장점은 다음과 같다.

1. 안정성 확보
   RAID에서는 HDD에 장애가 발생해도 데이터가 손실되지 않도록 데이터 기록을 이중화한다. HDD는 움직이는 부분이 많아서 고장이 쉽게 난다. 따라서 기록 처리를 이중화한다는 것은 매우 중요한 의미를 가진다.
2. 성능 향상
   RAID에서는 RAID 컨트롤러가 미리 정해놓은 길이로 I/O를 분할해서 복수의 HDD에 대해 병렬로 I/O 처리를 한다. 이 고정 길이를 RAID의 스트라이프 크기라고 부른다.

여러 개의 HDD를 병렬로 동시에 동작시키기 때문에 하나의 HDD를 동작시킬 때보다 I/O 처리 성능이 높아진다. 이 특성을 살리려면 하나의 RAID 그룹에 포함하는 HDD 수를 늘리면 된다. 대신에 한 대의 HDD 고장이 끼치는 영향 범위도 커지기 때문에 상충 관계에 있다고 할 수 있다. 최근에는 I/O 성능 중시 경향이 있어서 하나의 RAID 그룹 크기가 커지고 있다. 8 ~ 15대 정도가 하나의 그룹을 이룬다.

3. 용량 확장
   한 대의 HDD 용량은 기술 발전과 함께 점점 커지고 있지만, 그래도 물리적으로는 600GB, 1TB 등으로 정해져 있다. 논리 HDD는 이런 물리적 한계를 넘어서 자유롭게 용량을 결정할 수 있다. 예를 들어, 10TB를 하나의 파일 시스템으로 취급할 수도 있다.

### 웹 서버 이중화

### AP 서버 이중화

### DB 서버 이중화

### 네트워크 장비 이중화

### 사이트 이중화

### 감시

### 백업
